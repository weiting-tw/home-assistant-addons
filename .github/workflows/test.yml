name: Test

on:
  push:
    branches:
      - main
      - security-refactor
  pull_request:
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Hadolint - Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: claude-terminal/Dockerfile
          # DL3018: apk add without version pinning (acceptable for add-on)
          # DL3013: pip install without version pinning
          ignore: DL3006,DL3016,DL3018,DL3013

      - name: ShellCheck - Lint shell scripts
        run: |
          find . -name '*.sh' -type f -not -path './.git/*' | xargs shellcheck --severity=warning \
            --exclude=SC1091,SC2086,SC2154 || true
          echo "✅ ShellCheck completed (warnings only, non-blocking)"

      - name: yamllint - Validate YAML files
        run: |
          pip install --quiet yamllint
          cat > .yamllint.yml << 'YAMLEOF'
          extends: relaxed
          rules:
            line-length:
              max: 200
            truthy:
              check-keys: false
            comments:
              min-spaces-from-content: 1
          YAMLEOF
          find . -name '*.yaml' -o -name '*.yml' | grep -v node_modules | grep -v '.git/' | xargs yamllint -c .yamllint.yml

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks - Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Check .gitignore covers sensitive patterns
        run: |
          echo "Checking .gitignore for sensitive file patterns..."
          MISSING=0
          for pattern in "secrets.yaml" "*.key" "*.pem" ".env"; do
            if grep -qF "$pattern" .gitignore; then
              echo "✅ Found: $pattern"
            else
              echo "❌ Missing: $pattern"
              MISSING=1
            fi
          done
          if [ "$MISSING" -eq 1 ]; then exit 1; fi

      - name: Validate config.yaml security settings
        run: |
          python3 << 'PYEOF'
          import yaml, sys

          with open("claude-terminal/config.yaml") as f:
              config = yaml.safe_load(f)

          errors = []

          # hassio_role must not be admin or manager
          role = config.get("hassio_role", "default")
          if role in ("admin", "manager"):
              errors.append(f"hassio_role is '{role}' — must not be admin or manager")

          # No config mount at all, or only read-only
          mount_map = config.get("map") or []
          for entry in mount_map:
              if "config:rw" in str(entry):
                  errors.append("Found config:rw mapping — secrets.yaml would be exposed")

          # homeassistant_api should be false
          if config.get("homeassistant_api") not in (False, None):
              errors.append("homeassistant_api should be false")

          # auth_api should be false
          if config.get("auth_api") not in (False, None):
              errors.append("auth_api should be false")

          if errors:
              for e in errors:
                  print(f"❌ {e}")
              sys.exit(1)

          print("✅ All security settings validated")
          print(f"   hassio_role: {role}")
          print(f"   map: {mount_map}")
          print(f"   homeassistant_api: {config.get('homeassistant_api', 'not set')}")
          print(f"   auth_api: {config.get('auth_api', 'not set')}")
          PYEOF

  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (amd64)
        run: |
          docker build \
            --build-arg BUILD_FROM=ghcr.io/home-assistant/amd64-base:3.21 \
            -t claude-terminal-test \
            claude-terminal/

      - name: Smoke test - container starts
        run: |
          docker run -d --name ct-test \
            -e SUPERVISOR_TOKEN=fake \
            claude-terminal-test sleep 60

          sleep 3
          STATE=$(docker inspect -f '{{.State.Status}}' ct-test)
          if [[ "$STATE" != "running" ]]; then
            echo "❌ Container not running (state: $STATE)"
            docker logs ct-test
            exit 1
          fi
          echo "✅ Container is running"

      - name: Security - /config not mounted
        run: |
          # Verify no sensitive HA files are accessible
          # Note: /config dir may exist in base image but should be empty
          if docker exec ct-test test -f /config/secrets.yaml 2>/dev/null; then
            echo "❌ secrets.yaml is accessible inside container!"
            exit 1
          fi
          echo "✅ secrets.yaml not accessible"

          # Verify WORKDIR is /data
          WORKDIR=$(docker exec ct-test pwd)
          if [[ "$WORKDIR" != "/data" ]]; then
            echo "❌ WORKDIR is $WORKDIR, expected /data"
            exit 1
          fi
          echo "✅ WORKDIR is /data"

      - name: Verify claude CLI exists
        run: |
          docker exec ct-test which claude && echo "✅ claude CLI found"

      - name: Verify node is available
        run: |
          docker exec ct-test node --version && echo "✅ node is available"

      - name: Verify no unnecessary packages
        run: |
          # These packages should NOT be installed (removed for security)
          for pkg in vim wget tree yq; do
            if docker exec ct-test which $pkg 2>/dev/null; then
              echo "⚠️ Unnecessary package found: $pkg"
            else
              echo "✅ $pkg not installed (good)"
            fi
          done

      - name: Verify scripts are executable
        run: |
          docker exec ct-test test -x /run.sh && echo "✅ /run.sh is executable"
          docker exec ct-test test -d /opt/scripts && echo "✅ /opt/scripts exists"
          docker exec ct-test find /opt/scripts -name '*.sh' -not -executable | while read f; do
            echo "❌ Script not executable: $f"
            exit 1
          done
          echo "✅ All scripts are executable"

      - name: Cleanup
        if: always()
        run: docker rm -f ct-test || true

  config-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate config.yaml schema
        run: |
          python3 << 'PYEOF'
          import yaml, sys, re

          with open("claude-terminal/config.yaml") as f:
              config = yaml.safe_load(f)

          errors = []

          # Required top-level keys
          required = ["name", "description", "version", "slug", "arch", "ingress", "ingress_port"]
          for key in required:
              if key not in config:
                  errors.append(f"Missing required key: {key}")

          # Version format: semver
          version = config.get("version", "")
          if not re.match(r'^\d+\.\d+\.\d+$', str(version)):
              errors.append(f"Invalid version format: {version} (expected semver X.Y.Z)")

          # Arch must include amd64 and aarch64
          arch = config.get("arch", [])
          for required_arch in ["amd64", "aarch64"]:
              if required_arch not in arch:
                  errors.append(f"Missing required architecture: {required_arch}")

          # slug format
          slug = config.get("slug", "")
          if not re.match(r'^[a-z0-9_]+$', str(slug)):
              errors.append(f"Invalid slug format: {slug}")

          # ingress_port must be a number
          port = config.get("ingress_port")
          if not isinstance(port, int):
              errors.append(f"ingress_port must be integer, got: {type(port).__name__}")

          if errors:
              for e in errors:
                  print(f"❌ {e}")
              sys.exit(1)

          print("✅ config.yaml schema validation passed")
          print(f"   name: {config['name']}")
          print(f"   version: {config['version']}")
          print(f"   slug: {config['slug']}")
          print(f"   arch: {config['arch']}")
          print(f"   ingress_port: {config['ingress_port']}")
          PYEOF

      - name: Validate build.yaml
        run: |
          python3 << 'PYEOF'
          import yaml, sys

          with open("claude-terminal/build.yaml") as f:
              build = yaml.safe_load(f)

          errors = []

          # build_from must have amd64 and aarch64
          bf = build.get("build_from", {})
          for arch in ["amd64", "aarch64"]:
              if arch not in bf:
                  errors.append(f"Missing build_from for: {arch}")

          # labels should exist
          labels = build.get("labels", {})
          if not labels.get("org.opencontainers.image.title"):
              errors.append("Missing OCI label: title")

          if errors:
              for e in errors:
                  print(f"❌ {e}")
              sys.exit(1)

          print("✅ build.yaml validation passed")
          PYEOF

      - name: Validate repository.yaml
        run: |
          python3 << 'PYEOF'
          import yaml, sys

          with open("repository.yaml") as f:
              repo = yaml.safe_load(f)

          errors = []
          if not repo.get("name"):
              errors.append("Missing name")
          if not repo.get("url"):
              errors.append("Missing url")
          if not repo.get("maintainer"):
              errors.append("Missing maintainer")

          # URL should match this repo
          url = repo.get("url", "")
          if "weiting-tw" not in url:
              errors.append(f"URL doesn't match repo owner: {url}")

          if errors:
              for e in errors:
                  print(f"❌ {e}")
              sys.exit(1)

          print("✅ repository.yaml validation passed")
          print(f"   maintainer: {repo['maintainer']}")
          PYEOF
